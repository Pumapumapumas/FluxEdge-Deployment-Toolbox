apiVersion: apps/v1
kind: Deployment
metadata:
  generateName: open-source-template-
  labels:
    app: open-source-template
spec:
  selector:
    matchLabels:
      app: open-source-template
  template:
    metadata:
      labels:
        app: open-source-template
    spec:
      dnsPolicy: None
      dnsConfig:
        nameservers:
          - 8.8.8.8
          - 1.1.1.1
      containers:
        - name: ubuntu
          image: ubuntu:22.04
          hostNetwork: true
          command:
            - /bin/bash
          args:
            - -c
            - |
              ########################################
              ## üìù Developer Configuration Section ##
              ########################################

              ### Modify these variables to easily adjust configuration settings when developing deployments ###

              # Ansible Configuration
              ANSIBLE_PLAYBOOK="environment_template.yml"  # Name of the Ansible playbook (edit per deployment!)
              ANSIBLE_PLAYBOOK_PATH="/mnt/data/FluxEdge-Deployment-Toolbox/ansible/playbooks/$ANSIBLE_PLAYBOOK"  # Full path (auto-generated)

              # Watchdog Configuration
              WATCHDOG_TIMEOUT=90  # ‚è≥ Maximum time (seconds) before watchdog forcefully kills setup (edit per deployment!)
              SETUP_LOG="/tmp/setup.log"  # üìù Log file for additional debugging
              
              # Readiness Probe Configuration
              READINESS_INITIAL_DELAY=5  # ‚è≥ Time before the first readiness check (seconds)
              READINESS_PERIOD=10  # üîÑ Interval between readiness checks (seconds)
              READINESS_FAILURE_THRESHOLD=6  # ‚ùå Max failed checks before marking as failed (edit this to change total wait time!!!)
              READINESS_SUCCESS_THRESHOLD=1  # ‚úÖ Required successful check count to mark as ready

              ########################################
              ##### End Developer Configuration ######
              ########################################

              setup() {
                echo "Starting setup process with a watchdog timeout of $WATCHDOG_TIMEOUT seconds..."
                echo "Logs will be stored in $SETUP_LOG"

                # üõë Start a watchdog process to terminate stuck deployments
                (
                  sleep $WATCHDOG_TIMEOUT
                  echo "‚ùå ERROR: Setup process timed out after $WATCHDOG_TIMEOUT seconds." | tee /tmp/setup-failed
                  pkill -P $$  # Kill all child processes
                  exit 1
                ) &
                TIMEOUT_PID=$!  # Store the watchdog process ID
                
                # üèóÔ∏è Begin setup tasks
                {
                  echo "Preventing tzdata prompts..." | tee -a $SETUP_LOG
                  export DEBIAN_FRONTEND=noninteractive
                  echo "tzdata tzdata/Areas select America" | debconf-set-selections
                  echo "tzdata tzdata/Zones/America select New_York" | debconf-set-selections
                  ln -fs /usr/share/zoneinfo/America/New_York /etc/localtime
                  dpkg-reconfigure -f noninteractive tzdata

                  echo "Updating system and installing dependencies..." | tee -a $SETUP_LOG
                  apt-get -y update && apt-get -y upgrade && apt-get -y install curl vim git tzdata ansible python3-apt 2>&1 | tee -a $SETUP_LOG || {
                    echo "‚ùå ERROR: Failed to install dependencies." | tee -a /tmp/setup-failed
                    kill $TIMEOUT_PID
                    exit 1
                  }

                  # Check if the mount path exists
                  echo "Checking for external mount path..." | tee -a $SETUP_LOG
                  if [ ! -d "/mnt/data" ]; then
                      echo "‚ùå ERROR: Mount path /mnt/data does not exist. Deployment cannot continue." | tee -a /tmp/setup-failed
                      kill $TIMEOUT_PID
                      exit 1
                  fi

                  # Clone Open Source deployment repository
                  if [ ! -d "/mnt/data/FluxEdge-Deployment-Toolbox" ]; then
                      echo "Cloning FluxEdge-Deployment-Toolbox..." | tee -a $SETUP_LOG
                      git clone https://github.com/helloskyy-io/FluxEdge-Deployment-Toolbox /mnt/data 2>&1 | tee -a $SETUP_LOG
                  else
                      echo "Repository already exists in /mnt/data. Pulling latest changes..." | tee -a $SETUP_LOG
                      cd /mnt/data/FluxEdge-Deployment-Toolbox && git pull 2>&1 | tee -a $SETUP_LOG
                  fi

                  # ‚úÖ Run Ansible Playbook
                  echo "Running Ansible Playbook: $ANSIBLE_PLAYBOOK_PATH" | tee -a $SETUP_LOG
                  ansible-playbook -i localhost, -c local "$ANSIBLE_PLAYBOOK_PATH" 2>&1 | tee -a $SETUP_LOG || {
                    echo "‚ùå ERROR: Ansible playbook execution failed." | tee -a /tmp/setup-failed
                    kill $TIMEOUT_PID
                    exit 1
                  }

                  # ‚úÖ If setup finishes successfully, kill watchdog and mark as ready
                  kill $TIMEOUT_PID
                  touch /tmp/setup-finished
                  echo "‚úÖ Setup completed successfully in under $WATCHDOG_TIMEOUT seconds!" | tee -a $SETUP_LOG
                } &
                
                # üöÄ Wait for setup to complete
                wait $!
              }

              # Execute the setup function
              setup
              
              # Keep container alive
              tail -f /dev/null

          readinessProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  if [ -f /tmp/setup-failed ]; then
                    echo "Deployment failed."
                    exit 1
                  elif [ -f /tmp/setup-finished ]; then
                    exit 0
                  else
                    exit 1
                  fi
            initialDelaySeconds: $READINESS_INITIAL_DELAY
            periodSeconds: $READINESS_PERIOD
            failureThreshold: $READINESS_FAILURE_THRESHOLD
            successThreshold: $READINESS_SUCCESS_THRESHOLD
          ports:
            - containerPort: 80
            - containerPort: 22
            - containerPort: 8888
            - containerPort: 7860
            - containerPort: 3000
          resources:
            requests:
              cpu: 4000m
              memory: 8192M
              ephemeral-storage: 10G
            limits:
              cpu: 4000m
              memory: 8192M
              ephemeral-storage: 10G
          volumeMounts:
            - mountPath: /mnt/data
---
apiVersion: v1
kind: Service
metadata:
  name: open-source-template-service
  labels:
    app: open-source-template
spec:
  selector:
    app: open-source-template
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 80
    - name: ssh
      protocol: TCP
      port: 22
      targetPort: 22
    - name: jupyter
      protocol: TCP
      port: 8888
      targetPort: 8888
    - name: web-ui
      protocol: TCP
      port: 7860
      targetPort: 7860
    - name: app
      protocol: TCP
      port: 3000
      targetPort: 3000
  type: ClusterIP
